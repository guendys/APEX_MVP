<!doctype html><html lang="en"><head><meta charset="UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>APEX MVP — Polished + Feedback (Updated)</title><script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" crossorigin="anonymous"></script><style>:root{--brand:#0f62fe;--brand-600:#0353e9;--brand-50:#edf5ff;--bg:#111213;--surface:#15171a;--surface-elev:#1a1d21;--border:#2a2e34;--text:#e9e9ee;--text-muted:#a6a8af;--success:#0e9f6e;--warn:#b45309;--danger:#b91c1c;--shadow:0 1px 2px rgba(0,0,0,.6),0 8px 24px rgba(0,0,0,.5);--radius:12px}@media (prefers-color-scheme:light){:root{--bg:#fff;--surface:#fff;--surface-elev:#fafafa;--border:#e5e7eb;--text:#111827;--text-muted:#6b7280;--shadow:0 1px 2px rgba(0,0,0,.06),0 2px 8px rgba(0,0,0,.06)}}#app,body,html{margin:0;padding:0;background:var(--bg);color:var(--text)}body{font-family:'Segoe UI',Arial,sans-serif;padding:14px}.hidden{display:none}.fx{display:-ms-flexbox;display:flex}.fxr{-ms-flex-direction:row;flex-direction:row}.fxc{-ms-flex-direction:column;flex-direction:column}.fxw{-ms-flex-wrap:wrap;flex-wrap:wrap}.ai-c{-ms-flex-align:center;align-items:center}.ai-s{-ms-flex-align:start;align-items:flex-start}.jc-c{-ms-flex-pack:center;justify-content:center}.jc-b{-ms-flex-pack:justify;justify-content:space-between}.jc-s{-ms-flex-pack:start;justify-content:flex-start}.flex-1{-ms-flex:1 1 auto;flex:1 1 auto}.mb-12{margin-bottom:12px}.mb-10{margin-bottom:10px}.mt-6{margin-top:6px}.mt-8{margin-top:8px}.mt-10{margin-top:10px}.ml-6{margin-left:6px}.ml-8{margin-left:8px}.mr-6{margin-right:6px}.row-gap>*+*{margin-left:8px}.col-gap>*+*{margin-top:8px}.w-auto{width:auto!important}.toolbar{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:justify;justify-content:space-between;margin-bottom:12px}.brand{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center}.logo{width:22px;height:22px;border-radius:6px;background:var(--brand);box-shadow:inset 0 -6px 12px rgba(255,255,255,.15);display:-ms-inline-flexbox;display:inline-flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;color:#fff;font-weight:700;font-size:12px;margin-right:8px}.env-badge{font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:var(--surface-elev);color:var(--text-muted);margin-left:8px}.pill{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-align:center;align-items:center;padding:3px 8px;border-radius:999px;background:var(--surface-elev);border:1px solid var(--border);font-size:12px;color:var(--text-muted)}.pill>*+*{margin-left:6px}#message-box{display:none;background:var(--brand-50);border:1px solid var(--brand);color:#0b3a8a;padding:10px;border-radius:8px;margin-bottom:12px;white-space:pre-wrap}.toast-wrap{position:fixed;right:12px;bottom:72px;display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;z-index:99999}.toast-wrap>*+*{margin-top:8px}.toast{background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--brand);box-shadow:var(--shadow);padding:10px 12px;border-radius:8px;min-width:240px}.toast .title{font-weight:600;margin-bottom:2px}.toast.success{border-left-color:var(--success)}.toast.warn{border-left-color:var(--warn)}.toast.danger{border-left-color:var(--danger)}.section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px;box-shadow:var(--shadow)}.section-header{display:-ms-flexbox;display:flex;-ms-flex-pack:justify;justify-content:space-between;-ms-flex-align:center;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;font-weight:600}.subtitle{font-weight:400;color:var(--text-muted);font-size:12px}.toggle-icon{transition:transform .25s ease;font-size:13px;opacity:.7}.section-header.active .toggle-icon{transform:rotate(180deg)}.section-content{max-height:0;overflow:hidden;transition:max-height .25s ease,padding .25s ease;padding:0 14px}.section-content.open{padding:12px 14px}.action-button{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;cursor:pointer;background:var(--brand);color:#fff;transition:transform .03s ease,background .12s ease,border-color .12s ease}.action-button:hover{background:var(--brand-600)}.action-button.secondary{background:var(--surface);color:var(--text)}.action-button.secondary:hover{border-color:rgba(107,114,128,.3)}.action-button.ghost{background:0 0;border-color:var(--brand);color:var(--brand)}.action-button.ghost:hover{background:rgba(15,98,254,.1)}.action-row{display:-ms-flexbox;display:flex}.action-row>*+*{margin-left:8px}.text-input{width:100%;height:36px;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text);padding:0 10px}.textarea{width:100%;min-height:90px;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text)}.row{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap}.half{-ms-flex:1 0 50%;flex:1 0 50%;box-sizing:border-box}.answer-card{background:var(--surface-elev);border:1px solid var(--border);border-radius:10px;padding:12px;position:relative}.answer-card h4{margin:0 0 6px 0}.answer-body p{margin:8px 0}.answer-body ul{margin:8px 0 8px 18px}.footnote-ref{vertical-align:super;font-size:.75em;margin-left:2px}.topnote{font-size:12px;color:var(--text-muted);margin-top:6px}.source-list{list-style:none;margin:10px 0 0 0;padding:0}.source-item{position:relative;overflow:hidden;border:1px solid var(--border);background:var(--surface);border-radius:10px;padding:10px;margin:8px 0}.source-row{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center}.source-row>*+*{margin-left:8px}.source-index{font-weight:700;min-width:28px;text-align:center}.source-title{-ms-flex:1 1 auto;flex:1 1 auto;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.source-meta{font-size:12px;color:var(--text-muted);margin-top:2px}.open-btn{margin-left:10px;padding:6px 10px;border-radius:999px;border:1px solid var(--brand);background:0 0;color:var(--brand);font-weight:600;cursor:pointer}.open-btn:hover{background:rgba(15,98,254,.1)}.right{margin-left:auto}#chat-content{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;max-height:48vh;overflow:hidden}#chat-wrap{-ms-flex:1 1 auto;flex:1 1 auto;overflow:auto;padding:6px 0 4px 0}.chat-wrap{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column}.chat-wrap>*+*{margin-top:8px}.chat-msg{display:-ms-flexbox;display:flex;-ms-flex-align:start;align-items:flex-start}.chat-msg>*+*{margin-left:8px}.avatar{width:24px;height:24px;border-radius:999px;background:var(--brand-50);color:var(--brand);display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;font-size:12px;font-weight:700}.chat-bubble{background:var(--surface-elev);border:1px solid var(--border);border-radius:12px;padding:8px 10px;max-width:100%;word-break:break-word}.chat-input-wrap{position:static;background:var(--surface);padding-top:6px}.chat-input-row{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;border-top:1px solid var(--border);padding:8px 0 4px 0}.chat-input-row>*+*{margin-left:8px}.send-btn{width:auto;padding:0 14px}.muted{font-size:12px;color:var(--text-muted)}.visually-hidden{position:absolute;left:-9999px}.spinner{margin-left:8px;width:12px;height:12px;border:2px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin .7s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.fn-ref{cursor:pointer;color:var(--brand)}.fn-ref:focus{outline:2px solid var(--brand);border-radius:2px}.fn-popover{position:absolute;z-index:1000;background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow);padding:10px 12px;border-radius:10px;display:none;max-width:320px;width:auto;word-break:break-word;white-space:normal}.fn-popover .title{font-weight:600;margin-bottom:4px}.fn-popover .meta{font-size:12px;color:var(--text-muted)}.fn-popover .actions{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;margin-top:8px}.fn-popover .actions>*+*{margin-left:8px}.source-item.highlight{animation:fn-flash 1.2s ease 1}@keyframes fn-flash{from{background:rgba(15,98,254,.15)}to{background:0 0}}.fb-row{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;border-top:1px dashed var(--border);margin-top:8px;padding-top:8px}.fb-label{font-size:12px;color:var(--text-muted);margin-right:8px}.thumb-btn{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;width:32px;height:28px;border:1px solid var(--border);border-radius:8px;background:var(--surface);cursor:pointer}.thumb-btn[aria-pressed=true]{border-color:var(--brand);box-shadow:0 0 0 2px rgba(15,98,254,.15) inset}.fb-add{margin-left:8px;font-size:12px;color:var(--brand);background:0 0;border:none;cursor:pointer}.fb-add:hover{text-decoration:underline}.fb-form{display:none;margin-top:8px}.fb-form.open{display:block}.fb-text{width:100%;min-height:70px;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text);padding:8px}.fb-actions{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;margin-top:6px}.fb-actions>*+*{margin-left:8px}.fb-small{font-size:12px;color:var(--text-muted)}.genpane-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:9998}.genpane{position:fixed;top:0;right:0;bottom:0;width:420px;max-width:92vw;background:var(--surface);border-left:1px solid var(--border);box-shadow:var(--shadow);display:none;z-index:9999}.genpane-backdrop.open,.genpane.open{display:block}.genpane .head{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:justify;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}.genpane .title{font-weight:700}.genpane .body{padding:12px 14px;overflow:auto;position:absolute;top:48px;bottom:0;left:0;right:0}.gen-label{font-size:12px;color:var(--text-muted);margin-bottom:6px;display:block}.gen-input{width:100%;min-height:110px;border:1px solid var(--border);border-radius:10px;background:var(--surface-elev);color:var(--text);padding:10px}.gen-actions{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;margin-top:8px}.gen-actions>*+*{margin-left:8px}.preview{margin-top:12px;background:var(--surface-elev);border:1px solid var(--border);border-radius:10px;padding:10px;min-height:120px}.preview table{border-collapse:collapse;width:100%;margin:8px 0}.preview td,.preview th{border:1px solid var(--border);padding:6px 8px;text-align:left}</style><script defer="defer" src="polyfill.js"></script><script defer="defer" src="taskpane.js"></script></head><body><div id="app" class="hidden"><div class="toolbar"><div class="brand"><div class="logo" aria-hidden="true">A</div><div>APEX</div><span class="env-badge">Demo Mode</span></div><div class="pill" id="status-pill">● Ready</div></div><div id="message-box" role="alert" aria-live="polite"></div><div class="action-row mb-12"><button id="suggest-edit-button" class="action-button" aria-label="Suggest Smart Edit">Suggest Smart Edit</button> <button id="document-audit-button" class="action-button secondary" aria-label="Evaluate current sentence">Evaluate Sentence</button></div><div class="action-row mb-12"><button id="live-mode-button" class="action-button secondary" aria-pressed="false">Enable Live Sentence Mode</button> <button id="clear-live-button" class="action-button secondary">Clear Live Markup</button></div><div class="section"><div id="gen-header" class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="gen-content"><span>Generated Content (Test) <span class="subtitle">Write directly into the Word doc</span></span> <span class="toggle-icon">▾</span></div><div id="gen-content" class="section-content" role="region" aria-labelledby="gen-header"><div class="answer-card"><p class="muted mt-6">Open the generator pane to compose a request, preview the response, and apply it to the document.</p><div class="row mt-8 row-gap"><button id="open-generator-pane" class="action-button">Open Generator Pane</button> <button id="probe-button" class="action-button secondary w-auto">Probe API (Memory+Feedback)</button></div></div></div></div><div class="section"><div id="rag-header" class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="rag-content"><span>RAG Analysis Results <span class="subtitle">Top sources and answer</span></span> <span class="toggle-icon">▾</span></div><div id="rag-content" class="section-content" role="region" aria-labelledby="rag-header"><div id="rag-items"></div></div></div><div class="section"><div id="live-header" class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="live-content"><span>Live Suggestions <span class="subtitle">This session</span></span> <span class="toggle-icon">▾</span></div><div id="live-content" class="section-content" role="region" aria-labelledby="live-header"><div id="live-items" class="col-gap"></div></div></div><div class="section"><div id="chat-header" class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="chat-content"><span>Project Chat <span class="subtitle">Ask about the project</span></span> <span class="toggle-icon">▾</span></div><div id="chat-content" class="section-content" role="region" aria-labelledby="chat-header"><div id="chat-wrap" class="chat-wrap"></div><div class="chat-input-wrap"><div class="chat-input-row"><label for="chat-input" class="visually-hidden">Chat input</label> <input id="chat-input" class="text-input" placeholder="Ask about the project…"/> <button id="chat-send-button" class="action-button send-btn">Send</button></div></div></div></div><div class="section"><div id="feedback-header" class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="feedback-content"><span>Demo Feedback <span class="subtitle">Tell us what you think</span></span> <span class="toggle-icon">▾</span></div><div id="feedback-content" class="section-content" role="region" aria-labelledby="feedback-header"><div><div class="fb-row"><div class="fb-label">Overall, was this helpful?</div><button class="thumb-btn" id="gfb-up" aria-label="Thumbs up" aria-pressed="false">👍</button> <button class="thumb-btn ml-8" id="gfb-down" aria-label="Thumbs down" aria-pressed="false">👎</button></div><div class="fb-form open" id="gfb-form" aria-hidden="false"><label for="gfb-text" class="fb-small">Comments (optional)</label> <textarea id="gfb-text" class="fb-text" placeholder="What worked well? What was confusing?"></textarea><div class="fb-actions"><button id="gfb-submit" class="action-button w-auto">Submit feedback</button> <span class="fb-small" id="gfb-status"></span></div></div></div></div></div></div><div id="genpane-backdrop" class="genpane-backdrop" aria-hidden="true"></div><aside id="genpane" class="genpane" role="dialog" aria-modal="true" aria-labelledby="genpane-title" aria-hidden="true"><div class="head"><div id="genpane-title" class="title">Content Generator</div><button id="genpane-close" class="action-button ghost w-auto">Close</button></div><div class="body"><label class="gen-label" for="genpane-input">Request</label> <textarea id="genpane-input" class="gen-input" placeholder="Describe what to generate…"></textarea><div class="gen-actions"><button id="genpane-generate" class="action-button w-auto">Generate Preview</button> <span id="genpane-status" class="muted ml-8"></span></div><div class="preview" id="genpane-preview" aria-live="polite"></div><div class="gen-actions mt-8"><button id="genpane-apply" class="action-button">Apply to Document</button> <button id="genpane-stream" class="action-button secondary w-auto">Streaming Demo → APEX:GEN</button></div></div></aside><div class="toast-wrap" id="toast-wrap" aria-live="polite"></div><script>!function(){"use strict";var e,t;const n="https://apex-apis.azurewebsites.net/api/feedback";var a={apiBase:"https://apex-apis.azurewebsites.net",get tenantId(){return localStorage.getItem("apexTenantId")||"company.com"},get userId(){return localStorage.getItem("apexUserId")||"user@company.com"},get sessionId(){var e=localStorage.getItem("apexChatSessionId");return e||(e="chat-"+(new Date).toISOString().replace(/[:.]/g,"")+"-"+Math.random().toString(36).slice(2,8),localStorage.setItem("apexChatSessionId",e)),e},get funcKey(){return localStorage.getItem("apexFuncKey")||""},get apiKey(){return localStorage.getItem("apexApiKey")||""}},r={baseUrl:"",previewApi:"",feedbackApi:n,spOrigin:"https://spirehi.sharepoint.com"};function o(t){e&&(e.textContent=t,e.style.display="block"),i(t,"info")}function i(e,t){var n=document.getElementById("toast-wrap");if(n){var a=document.createElement("div");a.className="toast"+(t?" "+t:""),a.innerHTML='<div class="title">'+(t?t.toUpperCase():"INFO")+"</div><div>"+s(e)+"</div>",n.appendChild(a),setTimeout(function(){n.contains(a)&&n.removeChild(a)},3500)}}function s(e){return String(e||"").replace(/[&<>"']/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]})}function c(e){if(null==e)return NaN;if("number"==typeof e)return e;var t=parseFloat(e);return isFinite(t)?t:NaN}function d(e){var t=(e||"").split(/[\\\/]/);return t[t.length-1]||e||"Source"}function u(e){return(e||"id-")+Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8)}function l(e){for(var t=["semantic_score","effective_score","score","similarity","similarity_score","score_pct"],n=0;n<t.length;n++){var a=c(e&&e[t[n]]);if(isFinite(a))return a}return NaN}function p(e){var t=(e||[]).map(l).filter(function(e){return isFinite(e)});return t.length?Math.max.apply(null,t):NaN}function m(e,t,n){var a="/"===t.charAt(0)?t:"/"+t;return e+"/_layouts/15/Doc.aspx?sourcedoc="+encodeURIComponent(a)+"&file="+encodeURIComponent(n||d(a))+"&action=default&mobileredirect=true"}function f(e,t){var n="/"===t.charAt(0)?t.slice(1):t;return e+"/"+String(n||"").split("/").map(function(e){return e?encodeURIComponent(e):e}).join("/")}function g(e){if(!e||"object"!=typeof e)return{name:"Source",path:"",webUrl:"",folderUrl:"",score:NaN};var t=e.title||e.name||d(e.sharepointurl||e.path||e.url||""),n=e.file_path||e.path||"",a=e.sharepointurl||e.webUrl||e.url||"",o="";if(a)try{o=new URL(a).origin}catch(e){o=r.spOrigin||""}else o=r.spOrigin||"";var i="";if(a)i=function(e,t){try{var n=new URL(e),a=n.pathname,r=t||d(a);return m(n.origin,a,r)}catch(t){return e}}(a,t);else if(o&&n&&t){i=m(o,("/"===n.charAt(0)?n:"/"+n)+"/"+t,t)}return{name:t,filePath:n,rawSharePointUrl:a,webUrl:i||a||"",folderUrl:o&&n?f(o,n):"",previewUrl:"",score:l(e)}}function h(e){return e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(?!\s)(.+?)\*/g,"<em>$1</em>")}function y(e){if(!e)return"";let t=String(e);return t=t.replace(/^\s*\((?:intro|document)\)\s*/i,""),t=t.replace(/(\S)\s+\|/g,"$1\n|"),t=t.replace(/\|\s*\|\s*\|/g,"|\n|"),t=t.replace(/(\n\|[^\n]+?\|)\s*(\|\s*-{3,}[^|\n]*\|)/g,"$1\n$2"),t=t.replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n"),t.trim()}function b(e){return/^\s*\|.+\|\s*$/.test(e)}function v(e){return/^\s*\|(?:\s*:?-{3,}\s*:?\s*\|)+\s*$/.test(e)}function w(e){return e.replace(/^\s*\|\s*/,"").replace(/\s*\|\s*$/,"").split(/\s*\|\s*/)}function E(e,t){const n=w(e[t]);let a=t+2;const r=[];for(;a<e.length&&b(e[a]);)r.push(w(e[a])),a++;return{header:n,rows:r,end:a}}function S(e,t,n){let a="";return n&&(a+="<h6>"+s(n)+"</h6>"),a+="<table><thead><tr>",e.forEach(e=>a+="<th>"+h(s(e.trim()))+"</th>"),a+="</tr></thead><tbody>",t.forEach(t=>{a+="<tr>";for(let n=0;n<e.length;n++){const e="string"==typeof t[n]?t[n]:"";a+="<td>"+h(s((e||"").trim()))+"</td>"}a+="</tr>"}),a+="</tbody></table>",a}function k(e){e=y(function(e){let t=String(e||"");return t=t.replace(/\[([^\]]+?)\]\(#(?:src-)?(\d+)\)/gi,"[$2]"),t=t.replace(/\((?:Document\s+)?Chunks?\s+(\d+)\s*(?:[,&]\s*(\d+))?\)/gi,(e,t,n)=>"["+t+"]"+(n?" ["+n+"]":"")),t=t.replace(/\[(?:Document\s+)?Chunks?\s+(\d+)\]/gi,"[$1]"),t=t.replace(/\(\s*(\[\d+\])\s*\)/g,"$1"),t=t.replace(/(\[\d+\])\s*(?:,|&|and)\s*(?=\[\d+\])/gi,"$1 "),t=function(e){return e.replace(/\(\s*#[A-Za-z0-9][\w-]{5,}[^)]*\)/g,"").replace(/\(\s*(?:https?:\/\/|www\.)[^)]*\)/gi,"").replace(/\(\s*aHR0[A-Za-z0-9+/=]{10,}[^)]*\)/g,"")}(t),t}(e));const t=String(e||"").split(/\r?\n/),n=[];let a=0;function r(e){const t=e.join(" ").trim();if(!t)return;const a=s(t).replace(/\n/g,"<br>");n.push("<p>"+h(a)+"</p>"),e.length=0}const o=[];for(;a<t.length;){const e=t[a];if(!e.trim()){r(o),a++;continue}const i=/^(#{1,6})\s+(.*)$/.exec(e);if(i)r(o),n.push("<h4>"+h(s(i[2]))+"</h4>"),a++;else{if(/^\s*[-*]\s+/.test(e)){r(o);const e=[];for(;a<t.length&&/^\s*[-*]\s+/.test(t[a]);)e.push(t[a].replace(/^\s*[-*]\s+/,"")),a++;n.push("<ul>"+e.map(e=>"<li>"+h(s(e))+"</li>").join("")+"</ul>");continue}if(b(e)&&a+1<t.length&&v(t[a+1])){r(o);const{header:e,rows:i,end:s}=E(t,a);n.push(S(e,i)),a=s;continue}o.push(e),a++}}return r(o),n.join("")}async function x(e){const t="https://apex-apis.azurewebsites.net/api/memory",n=a.funcKey,r=n?t+(t.includes("?")?"&":"?")+"code="+encodeURIComponent(n):t,o={...e,tenant_id:a.tenantId,timestamp:(new Date).toISOString()},i={"Content-Type":"application/json",Accept:"application/json","X-Tenant-ID":a.tenantId};a.apiKey&&(i["x-api-key"]=a.apiKey),a.funcKey&&!r.includes("code=")&&(i["x-functions-key"]=a.funcKey);try{const e=await fetch(r,{method:"POST",headers:i,body:JSON.stringify(o)}),t=await e.text().catch(()=>"");if(!e.ok)throw new Error("HTTP "+e.status+(t?" :: "+t:""));return!0}catch(t){return function(e){try{var t=JSON.parse(localStorage.getItem("apexMemoryQueue")||"[]");t.push({payload:e,ts:Date.now()}),localStorage.setItem("apexMemoryQueue",JSON.stringify(t))}catch(t){console.warn("Queue memory failed",t,e)}}(e),!1}}async function I(){var e=localStorage.getItem("apexMemoryQueue");if(e){var t=[];try{t=JSON.parse(e)||[]}catch(e){}for(var n=[],a=0;a<t.length;a++){await x(t[a].payload)||n.push(t[a])}n.length?localStorage.setItem("apexMemoryQueue",JSON.stringify(n)):localStorage.removeItem("apexMemoryQueue")}}function C(e,t){return x({content:String(t||""),user_id:a.userId,session_id:a.sessionId,role:"assistant"===e?"assistant":"user",message_type:"assistant"===e?"assistant":"user"})}async function _(e){const t=r.feedbackApi||n,o=a.funcKey,i=o?t+(t.includes("?")?"&":"?")+"code="+encodeURIComponent(o):t,s={...e,tenant_id:a.tenantId,timestamp:(new Date).toISOString()},c={"Content-Type":"application/json",Accept:"application/json","X-Tenant-ID":a.tenantId};a.apiKey&&(c["x-api-key"]=a.apiKey),a.funcKey&&!i.includes("code=")&&(c["x-functions-key"]=a.funcKey);try{const e=await fetch(i,{method:"POST",headers:c,body:JSON.stringify(s)}),t=await e.text().catch(()=>"");if(!e.ok)throw new Error("HTTP "+e.status+(t?" :: "+t:""));return!0}catch(t){return function(e){try{var t=JSON.parse(localStorage.getItem("apexFeedbackQueue")||"[]");t.push({payload:e,ts:Date.now()}),localStorage.setItem("apexFeedbackQueue",JSON.stringify(t))}catch(t){console.warn("Queue feedback failed",t,e)}}(e),!1}}async function N(){var e=localStorage.getItem("apexFeedbackQueue");if(e){var t=[];try{t=JSON.parse(e)||[]}catch(e){}for(var n=[],a=0;a<t.length;a++){await _(t[a].payload)||n.push(t[a])}n.length?localStorage.setItem("apexFeedbackQueue",JSON.stringify(n)):localStorage.removeItem("apexFeedbackQueue")}}function A(e){return"up"===e?5:"down"===e?2:3}function B(e){var t=document.createElement("div");t.className="fb-row",t.innerHTML='<div class="fb-label">Was this helpful?</div><button class="thumb-btn" aria-label="Thumbs up" aria-pressed="false" data-val="up">👍</button><button class="thumb-btn ml-8" aria-label="Thumbs down" aria-pressed="false" data-val="down">👎</button><button class="fb-add" type="button">Add comment</button>';var n=document.createElement("div");n.className="fb-form",n.setAttribute("aria-hidden","true"),n.innerHTML='<label class="fb-small">Comments (optional)</label><textarea class="fb-text" placeholder="What should we change or keep?"></textarea><div class="fb-actions"><button class="action-button w-auto fb-submit">Submit</button><span class="fb-small fb-hint">Docs: use [1] [2] to reference sources</span></div>';var r=document.createElement("div");r.appendChild(t),r.appendChild(n);var o=null;t.addEventListener("click",function(e){var a,r,i,s=e.target.closest(".thumb-btn");s&&(o=s.getAttribute("data-val"),a=o,r=t.querySelector('.thumb-btn[data-val="up"]'),i=t.querySelector('.thumb-btn[data-val="down"]'),r.setAttribute("aria-pressed",String("up"===a)),i.setAttribute("aria-pressed",String("down"===a)),n.classList.add("open"),n.setAttribute("aria-hidden","false")),e.target.closest(".fb-add")&&(n.classList.toggle("open"),n.setAttribute("aria-hidden",String(!n.classList.contains("open"))))});var s=e&&e.responseId||u("airesp-");return n.querySelector(".fb-submit").addEventListener("click",async function(){var e=n.querySelector(".fb-text").value||"",t={user_id:a.userId,feedback:e,rating:A(o||"none"),response_id:s},c=await _(t);i(c?"Thanks for the feedback!":"Saved feedback for later (offline).",c?"success":"warn"),r.querySelectorAll("button,textarea").forEach(function(e){e.disabled=!0})}),r}function L(e,t,n,a){a=a||{};var r=document.createElement("div");if(r.className="answer-card",n){var o=document.createElement("div");o.className="topnote",o.textContent=n,r.appendChild(o)}var i=document.createElement("div");i.className="answer-body",i.innerHTML=k(e||"—"),r.appendChild(i);var c=document.createElement("ol");c.className="source-list",(t||[]).map(g).forEach(function(e,t){var n=t+1,a=isFinite(e.score)?e.score.toFixed(3):"--",r=document.createElement("li");r.className="source-item",r.id="src-"+n;var o=document.createElement("div");o.className="source-row";var i=e.webUrl?'<a href="'+s(e.webUrl)+'" target="_blank" rel="noopener" class="source-title" title="'+s(e.name||"Source")+'">'+s(e.name||"Source")+"</a>":'<div class="source-title" title="'+s(e.name||"Source")+'">'+s(e.name||"Source")+"</div>";o.innerHTML='<div class="source-index">['+n+"]</div>"+i+'<div class="right">'+(e.folderUrl?'<button class="open-btn" data-i="'+n+'" data-which="folder">Open Folder</button>':"")+'<button class="open-btn" data-i="'+n+'" data-which="doc">Open</button></div>',r.appendChild(o);var d=document.createElement("div");d.className="source-meta";var u=e.filePath?" • "+e.filePath:"";d.textContent="(semantic "+a+")"+u,r.appendChild(d),r.setAttribute("data-name",e.name||""),r.setAttribute("data-filepath",e.filePath||""),r.setAttribute("data-weburl",e.webUrl||""),r.setAttribute("data-folderurl",e.folderUrl||""),r.setAttribute("data-spraw",e.rawSharePointUrl||""),c.appendChild(r)});var d=document.createElement("div");d.className="mt-10",d.innerHTML="<strong>Sources</strong>",r.appendChild(d),r.appendChild(c),c.addEventListener("click",function(e){var t=e.target.closest(".open-btn");if(t){var n=t.closest(".source-item"),a="folder"===(t.getAttribute("data-which")||"doc")?n.getAttribute("data-folderurl")||"":n.getAttribute("data-weburl")||n.getAttribute("data-spraw")||"";a&&window.open(a,"_blank")}});var l=B({section:a.section||"unknown",sources:t||[],answerText:e||"",note:n||"",responseId:a.responseId||u("airesp-")});return r.appendChild(l),r}function T(e,t,n){var a=document.getElementById("rag-items");a.innerHTML="",a.appendChild(L(e,t,n,{section:"rag"}))}async function O(){const e=await async function(){return Word.run(async e=>{const t=e.document.body.getRange();return t.load("text"),await e.sync(),t.text||""})}();window.fullDocText=e||"";const t=((e||"").split(/\r?\n/).filter(Boolean)[0]||"(Intro)").trim();return window.latestChunks=[{index:1,header:t,content:e||"",blocks:[{type:"heading",level:2,text:t},{type:"paragraph",text:(e||"").trim()}]}],{chunks:window.latestChunks,fullText:e}}function j(e){if(!Array.isArray(e))return"";const t=[];for(const n of e)if(n&&"object"==typeof n)if("heading"===n.type){const e=Math.min(Math.max(parseInt(n.level||2,10),1),6),a=(n.text||"").trim();a&&t.push("#".repeat(e)+" "+a)}else if("paragraph"===n.type){const e=(n.text||"").trim();e&&t.push(e)}else if("list"===n.type){const e=!!n.ordered;(n.items||[]).forEach((n,a)=>{const r=(n&&"object"==typeof n?n.text:n)||"";t.push((e?a+1+". ":"- ")+String(r))})}else if("table"===n.type){const e=Array.isArray(n.rows)?n.rows:[];if(e.length){n.caption&&t.push("###### "+n.caption);const a=e[0];t.push("| "+a.join(" | ")+" |"),t.push("|"+a.map(()=>" --- ").join("|")+"|");for(let n=1;n<e.length;n++)t.push("| "+e[n].join(" | ")+" |")}}return t.join("\n")}function P(e){if(!e)return"";if("string"==typeof e.refined_markdown&&e.refined_markdown.trim())return e.refined_markdown;if("string"==typeof e.refined_content&&e.refined_content.trim())return e.refined_content;if(Array.isArray(e.refined_blocks)&&e.refined_blocks.length)return j(e.refined_blocks);if(Array.isArray(e.blocks)&&e.blocks.length)return j(e.blocks);if("string"==typeof e.content&&e.content.trim())return e.content;const t=(e.header||"").trim();return t&&"(document)"!==t.toLowerCase()?`## ${t}`:""}async function F(e){const t=document.getElementById("genpane-status"),n=document.getElementById("genpane-preview");window.latestChunks&&window.latestChunks.length||window.fullDocText||(t.textContent="Reading document…",await O());const r=function(){const e=(new Date).toISOString(),t=Array.isArray(window.latestChunks)?window.latestChunks:[];return{snapshot_at:e,tenant_id:a.tenantId,user_id:a.userId,session_id:a.sessionId,chunk_count:t.length,chunks:t.map(e=>({index:e.index||0,header:e.header||"",content:e.content||"",blocks:Array.isArray(e.blocks)?e.blocks:[]}))}}();if(!r.chunks||!r.chunks.length)return void(t.textContent="No content to refine.");const o={document:r,prompt:String(e||"").trim()};t.textContent="Refining…";try{const e={"Content-Type":"application/json",Accept:"application/json","X-Tenant-ID":a.tenantId};a.apiKey&&(e["x-api-key"]=a.apiKey),a.funcKey&&(e["x-functions-key"]=a.funcKey);const r=await fetch("https://spire-ai-function.azurewebsites.net/api/refine",{method:"POST",headers:e,body:JSON.stringify(o)}),i=await r.text();if(!r.ok)throw new Error("HTTP "+r.status+" :: "+i);let s={};try{s=JSON.parse(i)}catch(e){s={raw:i}}let c=function(e){if(!e)return"";if(e.data){if("string"==typeof e.data.refined_markdown&&e.data.refined_markdown.trim())return e.data.refined_markdown;if("string"==typeof e.data.markdown&&e.data.markdown.trim())return e.data.markdown;if("string"==typeof e.data.text&&e.data.text.trim())return e.data.text;if(e.data.output){if("string"==typeof e.data.output.markdown&&e.data.output.markdown.trim())return e.data.output.markdown;if("string"==typeof e.data.output.text&&e.data.output.text.trim())return e.data.output.text}}const t=e.data&&e.data.document||e.document||e.data&&e.data.output&&e.data.output.document;if(t&&Array.isArray(t.chunks)&&t.chunks.length){const e=t.chunks.map(P).filter(Boolean).join("\n\n").trim();if(e)return e}try{const t=[];if(function e(n){if(n&&"object"==typeof n)for(const a of Object.keys(n)){const r=n[a];"string"==typeof r&&r.trim().length>40&&/\s/.test(r)?t.push(r.trim()):r&&"object"==typeof r&&e(r)}}(e),t.length)return t[0]}catch(e){}return""}(s);"(document)"===c.trim().toLowerCase()&&(c=""),c=y(c),c.trim()||(c="— No refined content in response —",console.debug("[refine] no markdown extracted; snippet:",i.slice(0,600))),n.innerHTML=k(c),t.textContent="Preview ready."}catch(e){t.textContent="Error: "+(e.message||e),i("Refine error","danger")}}function R(e){if(t){var n={Ready:["● Ready",""],Querying:["● Querying…","info"],Error:["● Error","danger"]},a=n[e]||n.Ready;t.textContent=a[0],t.className="pill "+(a[1]||"")}}async function D(){var t=document.getElementById("suggest-edit-button");t.disabled=!0;var n=document.createElement("span");n.className="spinner",t.appendChild(n);try{var a=await Word.run(function(e){var t=e.document.getSelection().load("text");return e.sync().then(function(){return t.text})});if(!String(a).trim())return void o("Please select text.");R("Querying");var r=await fetch("https://spire-ai-function.azurewebsites.net/api/rag_query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:a,options:{max_results:5}})}),i=await r.json();e.style.display="none";var s=i&&i.data&&Array.isArray(i.data.sources)?i.data.sources:[],c=p(s),d=isFinite(c)?"Top semantic score: "+c.toFixed(3):"";T(i&&i.success&&i.data&&i.data.answer?i.data.answer:"No reply.",s,d),M("rag")}catch(e){console.error(e),o("Error: "+e.message)}finally{t.disabled=!1,n&&n.parentNode&&n.parentNode.removeChild(n),R("Ready")}}async function U(){var t=document.getElementById("chat-send-button");t.disabled=!0;var n=document.createElement("span");n.className="spinner",t.appendChild(n);try{var a=document.getElementById("chat-input"),r=String(a.value||"").trim();if(!r)return t.disabled=!1,void(n.parentNode&&n.parentNode.removeChild(n));!function(e){var t=document.getElementById("chat-wrap"),n=document.createElement("div");n.className="chat-msg";var a=document.createElement("div");a.className="avatar",a.textContent="Y";var r=document.createElement("div");r.className="chat-bubble",r.textContent=e,n.appendChild(a),n.appendChild(r),t.appendChild(n),t.scrollTop=t.scrollHeight}(r),a.value="",await C("user",r),R("Querying");var i=await fetch("https://spire-ai-function.azurewebsites.net/api/rag_query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:r,options:{max_results:5}})}),s=await i.json();e.style.display="none";var c=s&&s.data&&Array.isArray(s.data.sources)?s.data.sources:[],d=p(c),u=isFinite(d)?"Top semantic score: "+d.toFixed(3):"",l=s&&s.success&&s.data&&s.data.answer?s.data.answer:"No reply.";!function(e,t,n){var a=document.getElementById("chat-wrap"),r=document.createElement("div");r.className="chat-msg";var o=document.createElement("div");o.className="avatar",o.textContent="B";var i=document.createElement("div");i.className="chat-bubble flex-1";var s=L(e,t,n,{section:"chat"});i.appendChild(s),r.appendChild(o),r.appendChild(i),a.appendChild(r),a.scrollTop=a.scrollHeight}(l,c,u),await C("assistant",l)}catch(e){console.error(e),o("Error: "+e.message),R("Error")}finally{t.disabled=!1,n&&n.parentNode&&n.parentNode.removeChild(n),R("Ready"),document.getElementById("chat-input").focus()}}async function K(){M("rag")}function M(e){var t=document.getElementById(e+"-header"),n=document.getElementById(e+"-content");t&&n&&(t.classList.contains("active")||(t.classList.add("active"),t.setAttribute("aria-expanded","true"),n.classList.add("open"),n.style.maxHeight="chat"!==e?n.scrollHeight+"px":""))}async function H(){const e=(new Date).toISOString();await x({content:"probe: "+e,user_id:a.userId,session_id:a.sessionId,role:"user",message_type:"user"}),await _({user_id:a.userId,feedback:"probe: "+e,rating:3,response_id:"probe-"+a.sessionId}),i("Probe sent — check Network + Console","success")}function Q(){document.getElementById("genpane").classList.add("open"),document.getElementById("genpane-backdrop").classList.add("open"),document.getElementById("genpane").setAttribute("aria-hidden","false"),document.getElementById("genpane-backdrop").setAttribute("aria-hidden","false")}function $(){document.getElementById("genpane").classList.remove("open"),document.getElementById("genpane-backdrop").classList.remove("open"),document.getElementById("genpane").setAttribute("aria-hidden","true"),document.getElementById("genpane-backdrop").setAttribute("aria-hidden","true")}function z(){var e=document.getElementById("genpane-input"),t=document.getElementById("genpane-preview"),n=document.getElementById("genpane-status");document.getElementById("open-generator-pane").addEventListener("click",Q),document.getElementById("genpane-close").addEventListener("click",$),document.getElementById("genpane-backdrop").addEventListener("click",$),document.getElementById("genpane-generate").addEventListener("click",async function(){const t=String(e.value||"").trim();n.textContent="Reading document…",await O(),await F(t)}),document.getElementById("genpane-apply").addEventListener("click",async function(){var e=t.textContent||"";if(e.trim())try{await async function(e,t){return t=t||"replace",Word.run(async n=>{const a=n.document.getSelection(),r="after"===t?Word.InsertLocation.after:"before"===t?Word.InsertLocation.before:Word.InsertLocation.replace;a.insertText(e,r),await n.sync()})}(e,"replace"),i("Inserted at selection.","success")}catch(e){i("Insert failed: "+(e.message||e),"danger")}else i("Nothing to apply. Generate first.","warn")}),document.getElementById("genpane-stream").addEventListener("click",async function(){var n=(t.textContent||"").trim()||e.value.trim()||"Streaming from APEX demo…";try{await async function(e,t){t=t||250;const n="APEX:GEN";await Word.run(async e=>{let t,a=e.document.contentControls.getByTag(n);if(a.load("items"),await e.sync(),a.items.length)t=a.items[0];else{t=e.document.body.insertParagraph(" ",Word.InsertLocation.end).insertContentControl(),t.title=n,t.tag=n;try{t.appearance="BoundingBox"}catch(e){}}t.insertText("","Replace"),await e.sync()});const a=e.match(/.{1,90}(\s|$)/g)||[e];for(let e=0;e<a.length;e++)await new Promise(e=>setTimeout(e,t)),await Word.run(async t=>{const n=t.document.contentControls.getByTag("APEX:GEN");if(n.load("items"),await t.sync(),n.items.length){const r=0===e?a[e]:a.slice(0,e+1).join("");n.items[0].insertText(r,"Replace"),await t.sync()}})}(n,110),i("Streaming to APEX:GEN…","success")}catch(e){i("Streaming failed: "+(e.message||e),"danger")}})}function J(){var n,r;e=document.getElementById("message-box"),t=document.getElementById("status-pill"),document.getElementById("app").classList.remove("hidden"),["gen","rag","live","chat","feedback"].forEach(function(e){var t=document.getElementById(e+"-header"),n=document.getElementById(e+"-content");t&&n&&(t.addEventListener("click",function(){var a=t.classList.toggle("active");t.setAttribute("aria-expanded",String(a)),a?(n.classList.add("open"),n.style.maxHeight="chat"===e?"":n.scrollHeight+"px"):(n.classList.remove("open"),n.style.maxHeight="0")}),t.addEventListener("keydown",function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click())}))}),["gen","rag","chat","live","feedback"].forEach(M),document.getElementById("suggest-edit-button").addEventListener("click",D),document.getElementById("chat-send-button").addEventListener("click",U),document.getElementById("document-audit-button").addEventListener("click",K),document.getElementById("clear-live-button").addEventListener("click",function(){o("Clear live markup (implementation kept from previous version).")}),z(),function(){var e=document.getElementById("gfb-up"),t=document.getElementById("gfb-down"),n=document.getElementById("gfb-text"),r=document.getElementById("gfb-submit"),o=document.getElementById("gfb-status"),s=null;function c(n){e.setAttribute("aria-pressed",String("up"===n)),t.setAttribute("aria-pressed",String("down"===n))}e.addEventListener("click",function(){c(s="up"),n.focus()}),t.addEventListener("click",function(){c(s="down"),n.focus()}),r.addEventListener("click",async function(){var c={user_id:a.userId,feedback:n.value||"",rating:A(s||"none"),response_id:"general-"+a.sessionId},d=await _(c);o.textContent=d?"Thanks!":"Saved for later (offline).",i(d?"Thanks for the feedback!":"Saved feedback for later (offline).",d?"success":"warn"),e.disabled=t.disabled=n.disabled=r.disabled=!0})}(),document.getElementById("probe-button").addEventListener("click",H),document.getElementById("chat-input").addEventListener("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),document.getElementById("chat-send-button").click())}),r=p(n=[{title:"Recommendations_for_EFS_OCM_Next_Steps_March_2025.docx",sharepointurl:"https://spirehi.sharepoint.com/sites/KendizoxSpire/Shared%20Documents/EFS%20Project/Recommendations_for_EFS_OCM_Next_Steps_March_2025.docx",file_path:"sites/KendizoxSpire/Shared Documents/EFS Project",semantic_score:3.26},{title:"EFS_Project_Charter_and_Structure_7.31.docx",sharepointurl:"https://spirehi.sharepoint.com/sites/KendizoxSpire/Shared%20Documents/EFS%20Project/EFS_Project_Charter_and_Structure_7.31.docx",file_path:"sites/KendizoxSpire/Shared Documents/EFS Project",semantic_score:3.142}]),T("Yes — the State of Hawaii is implementing a new **Enterprise Financial System (EFS)** as part of an ERP modernization initiative. See details [1] [2].",n,isFinite(r)?"Top semantic score: "+r.toFixed(3):""),R("Ready"),N(),I()}window.addEventListener("online",function(){N(),I()}),window.latestChunks=[],window.fullDocText="",window.apexProbe=H,Office&&"function"==typeof Office.onReady?Office.onReady(function(e){e.host===Office.HostType.Word&&J()}):Office.initialize=function(){J()},window.addEventListener("unhandledrejection",function(t){if(console.error("Unhandled rejection:",t.reason),e){var n=t.reason&&(t.reason.message||t.reason);e.textContent="Async error: "+n,e.style.display="block"}i(String(t.reason&&(t.reason.message||t.reason)),"danger")})}()</script></body></html>